<!DOCTYPE html>
<html>
<head>
  <title>Player Stats</title>
  <link rel="stylesheet" href="style.css">

  <style>
    /* Fixed site-wide header */
    .site-header {
      background-color: skyblue;
      color: white;
      text-align: center;
      padding: 20px;
      font-size: 1.6rem;
      font-weight: bold;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    /* Fixed navbar just below header */
    .navbar {
      background: #0B1636;
      display: flex;
      justify-content: center;
      gap: 20px;
      padding: 12px;
      position: fixed;
      top: 70px;
      left: 0;
      width: 100%;
      z-index: 999;
    }
    .navbar a { color: white; text-decoration: none; font-weight: 600; }
    .navbar a.active { text-decoration: underline; }

    body { margin: 0; padding-top: 130px; background: #f5f5f5; }

    .stats-page { padding: 25px; min-height: 100vh; }
    h1 { font-size: 1.8rem; margin-bottom: 0.25rem; color: #0B1636; }

    .card {
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      max-width: 960px;
      margin: 0 auto;
    }

    #tableWrap { overflow-x: auto; max-height: 750px; overflow-y: auto; }

    table { width: 100%; border-collapse: collapse; font-size: 1rem; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #e5e7eb; text-align: left; }
    th { font-weight: 700; background: #f1f5f9; position: sticky; top: 0; z-index: 5; }

    tr.rank-1 { background-color: #fff176 !important; }
    tr.rank-2 { background-color: #fff9c4 !important; }
    tr.rank-3 { background-color: #fffde7 !important; }

    .meta { color: #6b7280; font-size: 0.9rem; }
    .refresh { float: right; font-size: 0.9rem; color: #2563eb; cursor: pointer; text-decoration: underline; }
    .total-col { font-weight: bold; }
  </style>
</head>
<body>

<div class="site-header">SUNBURY CRICKET CLUB - ASHES FANTASY FUNDRAISER</div>
<div class="navbar">
  <a href="index.html">LEADERBOARD</a>
  <a href="teams.html">TEAMS</a>
  <a class="active" href="player-stats.html">PLAYER STATS</a>
  <a href="transfers.html">TRANSFERS</a>
  <a href="rules.html">RULES</a>
</div>

<div class="stats-page">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h1>Player Stats</h1>
      <div class="refresh" id="manualRefresh"></div>
    </div>

    <div id="lastUpdated" class="meta" style="margin-top:6px;">Last updated: —</div>
    <br>

    <div id="tableWrap">
      <table id="statsTable">
        <thead><tr id="theadRow"></tr></thead>
        <tbody id="tbodyRow"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXkhOKdWeUqIOOUoD_Gp9BVXXu3yrdbhQd97rPUazXEdycwI33SjUpOW8-kNaCmeVpP0q5o1ChHc41/pub?gid=326386520&single=true&output=csv";
const REFRESH_MS = 30000;

function parseCSV(text) {
  const rows = [];
  let cur = "", row = [], inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i], nxt = text[i+1];
    if (ch === '"') {
      if (inQuotes && nxt === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
      continue;
    }
    if (ch === "," && !inQuotes) { row.push(cur); cur = ""; continue; }
    if ((ch === "\n" || ch === "\r") && !inQuotes) {
      if (cur !== "" || row.length > 0) { row.push(cur); rows.push(row); cur = ""; row = []; }
      if (ch === "\r" && nxt === "\n") i++;
      continue;
    }
    cur += ch;
  }
  if (cur !== "" || row.length > 0) { row.push(cur); rows.push(row); }
  return rows;
}

async function fetchAndRenderStats() {
  try {
    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("Fetch failed: " + res.status);
    const txt = await res.text();
    const rows = parseCSV(txt);
    if (!rows.length) throw new Error("No data found.");

    const header = rows[0]; // first row (row 1) is headers
    const data = rows.slice(1).filter(r => r.some(c => (c || "").trim() !== ""));

    // ✅ Use I1 (header col index 8) for "Last updated"
    const lastUpdatedHeader = header[8] || ""; // column I
    document.getElementById("lastUpdated").textContent =
      "Last updated: " + (lastUpdatedHeader || "—");

    const thead = document.getElementById("theadRow");
    const tbody = document.getElementById("tbodyRow");
    thead.innerHTML = "";
    tbody.innerHTML = "";

    // Build header, skipping column I (index 8)
    header.forEach((h, ci) => {
      if (ci === 8) return; // skip column I
      const th = document.createElement("th");
      th.textContent = h || "—";
      thead.appendChild(th);
    });

    // Build rows, skipping column I (index 8)
    data.forEach(row => {
      const tr = document.createElement("tr");
      row.forEach((cell, ci) => {
        if (ci === 8) return; // skip column I
        const td = document.createElement("td");
        td.textContent = cell ?? "";
        if (/total/i.test(header[ci] || "")) td.classList.add("total-col");
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  } catch (err) {
    console.error(err);
    document.getElementById("lastUpdated").textContent = "Update failed: " + err.message;
  }
}

document.getElementById("manualRefresh").addEventListener("click", fetchAndRenderStats);
fetchAndRenderStats();
if (REFRESH_MS > 0) setInterval(fetchAndRenderStats, REFRESH_MS);
</script>

</body>
</html>
